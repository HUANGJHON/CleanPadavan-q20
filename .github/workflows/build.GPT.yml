name: Build Newifi3 D2 Padavan 3.4 (Optimized)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    
    env:
      DEBIAN_FRONTEND: noninteractive
      LC_ALL: C
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Maximize Build Space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean
        df -h

    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential gperf bison flex texinfo gawk \
          libncurses5-dev libncurses5 libncursesw5 libncursesw5-dev \
          zlib1g-dev liblzma-dev libgmp-dev libmpfr-dev libmpc-dev \
          autoconf automake autopoint libtool-bin gettext pkg-config \
          curl wget git rsync python3 python3-docutils \
          fakeroot kmod cpio git-doc nano xxd vim-common
        
        # é’ˆå¯¹Ubuntu 22.04ä¿®å¤GCCä¸¥æ ¼æ¨¡å¼
        sudo sed -i 's/-Werror=format-security//g' /usr/share/perl5/Debconf/Client/ConfModule.pm 2>/dev/null || true
        
        sudo apt-get clean
        df -h

    - name: Clone Padavan Source (hanwckf 3.4)
      run: |
        git clone --depth=1 https://github.com/hanwckf/rt-n56u.git padavan
        echo "BUILD_DATE=$(date +%Y%m%d_%H%M)" >> $GITHUB_ENV

    - name: Apply Critical Fixes for Ubuntu 22.04
      run: |
        cd padavan
        
        # ===========================
        # Fix 1: XZå·¥å…·é“¾ - ç¦ç”¨NLSé¿å…gettextç‰ˆæœ¬å†²çª
        # ===========================
        MKSQ_MK="trunk/tools/mksquashfs_xz/Makefile"
        if [ -f "$MKSQ_MK" ]; then
          echo "Patching mksquashfs_xz Makefile..."
          sed -i 's|./configure|./configure --disable-nls --disable-doc|g' "$MKSQ_MK"
        fi
        
        XZ_MAKEFILE="trunk/tools/mksquashfs_xz/xz-5.2.4/Makefile.in"
        if [ -f "$XZ_MAKEFILE" ]; then
          echo "Disabling XZ subdirs except src..."
          sed -i 's/^SUBDIRS.*/SUBDIRS = src/g' "$XZ_MAKEFILE"
        fi
        
        # ===========================
        # Fix 2: e2fsprogs - ç§»é™¤GNU gettextå®
        # ===========================
        E2FS_CONFIGURE="trunk/user/e2fsprogs/configure"
        if [ -f "$E2FS_CONFIGURE" ]; then
          echo "Removing gettext from e2fsprogs..."
          sed -i 's/AM_GNU_GETTEXT(external)/# AM_GNU_GETTEXT(external)/g' "$E2FS_CONFIGURE"
          sed -i 's/AM_GNU_GETTEXT_VERSION/# AM_GNU_GETTEXT_VERSION/g' "$E2FS_CONFIGURE"
          touch "$E2FS_CONFIGURE"
        fi
        
        # ===========================
        # Fix 3: Dropbear - å…³é”®ä¿®å¤
        # ===========================
        DROPBEAR_MK="trunk/user/dropbear/Makefile"
        if [ -f "$DROPBEAR_MK" ]; then
          echo "Applying Dropbear Makefile fix..."
          
          # ç§»é™¤autoreconf(Ubuntu 22.04ç‰ˆæœ¬å¤ªæ–°)
          sed -i 's/autoreconf.*;//g' "$DROPBEAR_MK"
          
          # æ¸…ç†æ‰€æœ‰å½¢å¼çš„CC=$(CC)å‚æ•°ä¼ é€’
          sed -i -E 's/(CC|CFLAGS|LDFLAGS)\s*=\s*\$\(\1\)//g' "$DROPBEAR_MK"
          
          # ä½¿ç”¨ç¯å¢ƒå˜é‡å¯¼å‡ºæ–¹å¼(æœ€ç¨³å®š)
          sed -i 's|^\([[:space:]]*\)\./configure|\1export CC="\$(CC)" CFLAGS="\$(CFLAGS)" LDFLAGS="\$(LDFLAGS)" LIBS="-lz -lcrypt"; ./configure|g' "$DROPBEAR_MK"
          
          echo "Dropbear configure line:"
          grep -A2 "export CC" "$DROPBEAR_MK" || grep "./configure" "$DROPBEAR_MK"
        fi
        
        # ===========================
        # Fix 4: å…¨å±€GCCå…¼å®¹æ€§ä¿®å¤
        # ===========================
        # ä¸ºè€æ—§ä»£ç æ·»åŠ å®½æ¾ç¼–è¯‘é€‰é¡¹
        find trunk/user -name "Makefile*" -o -name "*.mk" | while read mf; do
          if grep -q "CFLAGS.*-Werror" "$mf" 2>/dev/null; then
            sed -i 's/-Werror[^ ]*//g' "$mf"
          fi
        done

    - name: Setup Toolchain
      run: |
        cd padavan/toolchain-mipsel
        
        echo "Downloading toolchain..."
        sh dl_toolchain.sh
        
        if [ ! -f "toolchain-3.4.x/bin/mipsel-linux-uclibc-gcc" ]; then
          echo "ERROR: Toolchain download failed!"
          exit 1
        fi
        
        # åˆ›å»ºæ ‡å‡†è·¯å¾„ç¬¦å·é“¾æ¥
        sudo mkdir -p /opt/rt-n56u
        sudo ln -sf "$(pwd)/toolchain-3.4.x" /opt/rt-n56u/toolchain-mipsel
        
        # éªŒè¯å·¥å…·é“¾
        export PATH="/opt/rt-n56u/toolchain-mipsel/bin:$PATH"
        
        if ! mipsel-linux-uclibc-gcc --version; then
          echo "ERROR: Toolchain verification failed!"
          exit 1
        fi
        
        echo "Toolchain ready: $(mipsel-linux-uclibc-gcc --version | head -n1)"

    - name: Configure Firmware Template
      run: |
        cd padavan/trunk/configs/templates
        
        TARGET="NEWIFI3"
        
        # ç”Ÿæˆå®Œæ•´é…ç½®æ–‡ä»¶
        cat > "${TARGET}.config" <<EOF
        # åŸºç¡€é…ç½®
        CONFIG_VENDOR=ralink
        CONFIG_PRODUCT=MT7621
        CONFIG_LINUXDIR=linux-3.4.x
        
        # ç¡¬ä»¶è§„æ ¼
        CONFIG_FIRMWARE_PRODUCT_ID="NEWIFI3"
        CONFIG_FIRMWARE_CPU_MT7621=y
        CONFIG_FIRMWARE_MEMORY_512M=y
        CONFIG_FIRMWARE_FLASH_32M=y
        
        # æ ¸å¿ƒåŠŸèƒ½
        CONFIG_FIRMWARE_ENABLE_USB=y
        CONFIG_FIRMWARE_INCLUDE_HTTPS=y
        CONFIG_FIRMWARE_INCLUDE_SFTP=y
        CONFIG_FIRMWARE_INCLUDE_DROPBEAR=y
        
        # WiFié©±åŠ¨
        CONFIG_FIRMWARE_WIFI2_DRIVER=3.0
        CONFIG_FIRMWARE_WIFI5_DRIVER=3.0
        
        # ç½‘ç»œä¼˜åŒ–
        CONFIG_FIRMWARE_ENABLE_IPV6=y
        CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y
        
        # ç¦ç”¨æ’ä»¶(çº¯å‡€ç‰ˆ)
        CONFIG_FIRMWARE_INCLUDE_ARIA=n
        CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n
        CONFIG_FIRMWARE_INCLUDE_WGET=n
        CONFIG_FIRMWARE_INCLUDE_OPENVPN=n
        CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n
        CONFIG_FIRMWARE_INCLUDE_SSSERVER=n
        CONFIG_FIRMWARE_INCLUDE_TROJAN=n
        CONFIG_FIRMWARE_INCLUDE_V2RAY=n
        CONFIG_FIRMWARE_INCLUDE_XRAY=n
        CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_SERVER=n
        CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_CLIENT=n
        EOF
        
        echo "Configuration created for $TARGET"

    - name: Build Firmware
      run: |
        cd padavan/trunk
        
        export PATH="/opt/rt-n56u/toolchain-mipsel/bin:$PATH"
        export LC_ALL=C
        export CFLAGS="-O2 -pipe"
        
        # å¤åˆ¶é…ç½®
        cp -f configs/templates/NEWIFI3.config .config
        
        echo "======================================"
        echo "Starting Clean Build Process"
        echo "======================================"
        
        # æ¸…ç†
        make clean
        
        # åˆ†é˜¶æ®µç¼–è¯‘(å…³é”®)
        echo ">>> Stage 1: Building toolchain dependencies..."
        fakeroot make toolchain || {
          echo "ERROR: Toolchain build failed"
          exit 1
        }
        
        echo ">>> Stage 2: Building libraries..."
        fakeroot make libs || {
          echo "ERROR: Library compilation failed"
          tail -n 100 /tmp/*.log 2>/dev/null || true
          exit 1
        }
        
        echo ">>> Stage 3: Building firmware..."
        fakeroot ./build_firmware_modify NEWIFI3 0
        
        # æ£€æŸ¥è¾“å‡º
        if [ ! -f "images/"*.trx ]; then
          echo "ERROR: Firmware build failed - no .trx file generated"
          find images -type f
          exit 1
        fi
        
        echo "======================================"
        echo "Build Success!"
        ls -lh images/*.trx
        echo "======================================"

    - name: Prepare Release Files
      run: |
        mkdir -p release
        
        # å¤åˆ¶å›ºä»¶
        cp padavan/trunk/images/*.trx release/
        
        # é‡å‘½åä¸ºæ ‡å‡†æ ¼å¼
        cd release
        for file in *.trx; do
          mv "$file" "Newifi3_Padavan_3.4_${{ env.BUILD_DATE }}.trx"
        done
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        sha256sum *.trx > sha256sum.txt
        
        # ç”Ÿæˆè¯´æ˜æ–‡ä»¶
        cat > README.txt <<EOF
        å›ºä»¶ä¿¡æ¯
        ========================================
        è®¾å¤‡å‹å·: Newifi3 D2 (NEWIFI3)
        å›ºä»¶ç‰ˆæœ¬: Padavan 3.4 (hanwckf)
        å†…æ ¸ç‰ˆæœ¬: Linux 3.4.x
        ç¼–è¯‘æ—¶é—´: ${{ env.BUILD_DATE }}
        ç¼–è¯‘ç¯å¢ƒ: Ubuntu 22.04
        
        åŠŸèƒ½ç‰¹æ€§
        ========================================
        - ç¡¬ä»¶æµé‡åŠ é€Ÿ(Flow Offload)å·²å¯ç”¨
        - IPv6 åŸç”Ÿæ”¯æŒ
        - SSH/SFTP/HTTPS å·²å¯ç”¨
        - çº¯å‡€ç‰ˆ(æ— ç¬¬ä¸‰æ–¹ä»£ç†æ’ä»¶)
        
        åˆ·æœºæ–¹æ³•
        ========================================
        1. ç™»å½•è·¯ç”±å™¨Webç•Œé¢
        2. è¿›å…¥"ç³»ç»Ÿç®¡ç†" -> "å›ºä»¶å‡çº§"
        3. é€‰æ‹©.trxæ–‡ä»¶ä¸Šä¼ 
        4. ç­‰å¾…è‡ªåŠ¨é‡å¯å®Œæˆ
        
        æ³¨æ„äº‹é¡¹
        ========================================
        - é¦–æ¬¡åˆ·æœºå»ºè®®å‹¾é€‰"æ¸…é™¤é…ç½®"
        - é»˜è®¤IP: 192.168.2.1
        - é»˜è®¤ç”¨æˆ·å/å¯†ç : admin/admin
        EOF
        
        ls -lh

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.BUILD_DATE }}-padavan3.4
        name: "Newifi3 Padavan 3.4 (${{ env.BUILD_DATE }})"
        body: |
          ## ğŸ“¦ è‡ªåŠ¨æ„å»ºå›ºä»¶
          
          **è®¾å¤‡å‹å·**: Newifi3 D2  
          **å›ºä»¶ç‰ˆæœ¬**: Padavan 3.4 (hanwckf/rt-n56u)  
          **ç¼–è¯‘æ—¶é—´**: ${{ env.BUILD_DATE }}  
          **ç¼–è¯‘ç¯å¢ƒ**: Ubuntu 22.04 LTS  
          
          ### âœ¨ ç‰¹æ€§
          - âœ… ç¡¬ä»¶æµé‡åŠ é€Ÿ (Flow Offload)
          - âœ… IPv6 åŸç”Ÿæ”¯æŒ
          - âœ… SSH/SFTP/HTTPS
          - âœ… çº¯å‡€ç‰ˆ(æ— ä»£ç†æ’ä»¶)
          
          ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•
          ä¸‹è½½`.trx`æ–‡ä»¶ï¼Œé€šè¿‡è·¯ç”±å™¨Webç•Œé¢ä¸Šä¼ åˆ·æœº
          
          **é»˜è®¤è®¿é—®**: http://192.168.2.1 (admin/admin)
        files: |
          release/*.trx
          release/sha256sum.txt
          release/README.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifacts (Backup)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: padavan-firmware-${{ env.BUILD_DATE }}
        path: |
          release/*.trx
          release/*.txt
        retention-days: 30
