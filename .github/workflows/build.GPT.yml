name: Build Newifi3 D2 Padavan 3.4 (GPT 5.1)

on:
  workflow_dispatch:
    inputs:
      enable_debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ (ä¿ç•™æ„å»ºç›®å½•)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    
    env:
      # æ ¸å¿ƒç¯å¢ƒå˜é‡
      DEBIAN_FRONTEND: noninteractive
      LC_ALL: C
      TZ: Asia/Shanghai
      
    steps:
    - name: Maximize Build Space
      run: |
        echo "æ¸…ç† Ubuntu é•œåƒé¢„è£…è½¯ä»¶ä»¥é‡Šæ”¾ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean
        df -h
        
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Install Build Dependencies
      run: |
        echo "æ›´æ–°è½¯ä»¶æºå¹¶å®‰è£…ä¾èµ–åŒ…..."
        sudo apt-get update -qq
        
        # æ ¸å¿ƒç¼–è¯‘ä¾èµ–
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          autoconf automake autopoint \
          libtool libtool-bin \
          cmake \
          gperf gawk flex bison \
          curl wget git \
          fakeroot kmod cpio \
          xxd nano vim-common \
          texinfo gettext \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev libncurses5 \
          python3 python3-docutils \
          libgmp-dev libmpfr-dev libmpc-dev
          
        # æ¸…ç† APT ç¼“å­˜
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
        echo "ä¾èµ–åŒ…å®‰è£…å®Œæˆ"
        
    - name: Configure Build Environment
      run: |
        # è®¾ç½®æ„å»ºæ—¥æœŸ
        BUILD_DATE=$(date +%Y%m%d-%H%M)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        
        # å®šä¹‰å·¥ä½œç›®å½•
        WORK_ROOT="${GITHUB_WORKSPACE}/build"
        echo "WORK_ROOT=$WORK_ROOT" >> $GITHUB_ENV
        mkdir -p "$WORK_ROOT"
        
        echo "âœ“ æ„å»ºç¯å¢ƒé…ç½®å®Œæˆ"
        echo "  - æ„å»ºæ—¶é—´: $BUILD_DATE"
        echo "  - å·¥ä½œç›®å½•: $WORK_ROOT"
        
    - name: Clone Padavan 3.4 Source
      run: |
        echo "å…‹éš† hanwckf rt-n56u æºç  (3.4 å†…æ ¸)..."
        cd "$WORK_ROOT"
        
        git clone --depth=1 \
          --single-branch \
          --branch master \
          https://github.com/hanwckf/rt-n56u.git \
          padavan
          
        echo "PADAVAN_DIR=$WORK_ROOT/padavan" >> $GITHUB_ENV
        echo "âœ“ æºç å…‹éš†å®Œæˆ: $(du -sh padavan | cut -f1)"
        
    - name: Apply Ubuntu 22.04 Compatibility Patches
      run: |
        cd "$PADAVAN_DIR"
        echo "åº”ç”¨ Ubuntu 22.04 å…¼å®¹æ€§è¡¥ä¸..."
        
        # ============================================
        # è¡¥ä¸ 1: xz-utils (mksquashfs_xz)
        # é—®é¢˜: gettext å¯¼è‡´ç¼–è¯‘å¤±è´¥
        # ============================================
        echo "[1/4] ä¿®å¤ xz-utils..."
        XZ_MAKEFILE="trunk/tools/mksquashfs_xz/Makefile"
        if [ -f "$XZ_MAKEFILE" ]; then
          sed -i 's|./configure|./configure --disable-nls --disable-doc|g' "$XZ_MAKEFILE"
          echo "  âœ“ å·²ç¦ç”¨ xz çš„ NLS å’Œæ–‡æ¡£ç¼–è¯‘"
        fi
        
        XZ_MAKEFILE_IN="trunk/tools/mksquashfs_xz/xz-5.2.4/Makefile.in"
        if [ -f "$XZ_MAKEFILE_IN" ]; then
          sed -i 's/^SUBDIRS.*/SUBDIRS = src/g' "$XZ_MAKEFILE_IN"
          echo "  âœ“ é™åˆ¶ xz åªç¼–è¯‘ src ç›®å½•"
        fi
        
        # ============================================
        # è¡¥ä¸ 2: e2fsprogs (æ–‡ä»¶ç³»ç»Ÿå·¥å…·)
        # é—®é¢˜: AM_GNU_GETTEXT å®åœ¨æ–°ç‰ˆ autoconf ä¸­å¤±æ•ˆ
        # ============================================
        echo "[2/4] ä¿®å¤ e2fsprogs..."
        E2FS_CONFIGURE="trunk/user/e2fsprogs/configure"
        if [ -f "$E2FS_CONFIGURE" ]; then
          # æ³¨é‡Šæ‰ gettext ç›¸å…³å®
          sed -i 's/AM_GNU_GETTEXT(\[external\])/# &/g' "$E2FS_CONFIGURE"
          sed -i 's/AM_GNU_GETTEXT_VERSION/# &/g' "$E2FS_CONFIGURE"
          
          # å¼ºåˆ¶åˆ·æ–° configure æ—¶é—´æˆ³,é¿å…é‡æ–°ç”Ÿæˆ
          touch "$E2FS_CONFIGURE"
          echo "  âœ“ å·²ç§»é™¤ e2fsprogs çš„ gettext ä¾èµ–"
        fi
        
        # ============================================
        # è¡¥ä¸ 3: dropbear (SSH æœåŠ¡å™¨)
        # é—®é¢˜: CC=$(CC) å‚æ•°ä¼ é€’å¯¼è‡´ configure å¤±è´¥
        # ============================================
        echo "[3/4] ä¿®å¤ dropbear..."
        DROPBEAR_MK="trunk/user/dropbear/Makefile"
        if [ -f "$DROPBEAR_MK" ]; then
          # ç­–ç•¥: é€šè¿‡ç¯å¢ƒå˜é‡è€Œéå‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç¼–è¯‘å™¨é…ç½®
          # ç§»é™¤ autoreconf (ä¸éœ€è¦é‡æ–°ç”Ÿæˆ configure)
          sed -i '/autoreconf/d' "$DROPBEAR_MK"
          
          # æ¸…ç† configure å‘½ä»¤ä¸­çš„æ˜¾å¼å˜é‡èµ‹å€¼
          sed -i -E 's/\s+CC=\$\(CC\)//g' "$DROPBEAR_MK"
          sed -i -E 's/\s+CFLAGS=\$\(CFLAGS\)//g' "$DROPBEAR_MK"
          sed -i -E 's/\s+LDFLAGS=\$\(LDFLAGS\)//g' "$DROPBEAR_MK"
          
          # ä½¿ç”¨ export æ–¹å¼åœ¨å­ shell ä¸­è®¾ç½®ç¯å¢ƒå˜é‡
          sed -i 's|\(\s*\)\./configure|\1( export CC="$(CC)" CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)"; ./configure )|g' "$DROPBEAR_MK"
          
          echo "  âœ“ dropbear Makefile å·²ä¼˜åŒ–"
        fi
        
        # ============================================
        # è¡¥ä¸ 4: å…¨å±€ç¼–è¯‘å™¨æ ‡å¿—è°ƒæ•´
        # é—®é¢˜: GCC 12+ å°†æŸäº›è­¦å‘Šè§†ä¸ºé”™è¯¯
        # ============================================
        echo "[4/4] è°ƒæ•´å…¨å±€ç¼–è¯‘æ ‡å¿—..."
        
        # æŸ¥æ‰¾å¹¶ä¿®æ”¹ä¸» Makefile
        TRUNK_RULES="trunk/user/Makefile"
        if [ -f "$TRUNK_RULES" ]; then
          # åœ¨ CFLAGS ä¸­æ·»åŠ å®½æ¾è­¦å‘Šé€‰é¡¹
          if ! grep -q "Wno-error=format-security" "$TRUNK_RULES"; then
            sed -i '/^export CFLAGS/s/$/ -Wno-error=format-security -Wno-error=stringop-overflow/' "$TRUNK_RULES"
            echo "  âœ“ å·²æ·»åŠ  GCC 12 å…¼å®¹æ€§æ ‡å¿—"
          fi
        fi
        
        echo "âœ“ æ‰€æœ‰è¡¥ä¸åº”ç”¨å®Œæˆ"
        
    - name: Prepare Toolchain
      run: |
        echo "å‡†å¤‡ MIPSEL äº¤å‰ç¼–è¯‘å·¥å…·é“¾..."
        cd "$PADAVAN_DIR/toolchain-mipsel"
        
        # ä¸‹è½½é¢„ç¼–è¯‘å·¥å…·é“¾
        bash dl_toolchain.sh
        
        # åˆ›å»ºç¬¦å·é“¾æ¥åˆ°æ ‡å‡†è·¯å¾„
        TOOLCHAIN_PATH="$PADAVAN_DIR/toolchain-mipsel/toolchain-3.4.x"
        sudo mkdir -p /opt/rt-n56u
        sudo ln -sf "$TOOLCHAIN_PATH" /opt/rt-n56u/toolchain-mipsel
        
        # è®¾ç½® PATH
        echo "/opt/rt-n56u/toolchain-mipsel/bin" >> $GITHUB_PATH
        export PATH="/opt/rt-n56u/toolchain-mipsel/bin:$PATH"
        
        # éªŒè¯å·¥å…·é“¾
        if ! command -v mipsel-linux-uclibc-gcc &> /dev/null; then
          echo "âŒ é”™è¯¯: å·¥å…·é“¾å®‰è£…å¤±è´¥"
          exit 1
        fi
        
        echo "âœ“ å·¥å…·é“¾å‡†å¤‡å®Œæˆ"
        mipsel-linux-uclibc-gcc --version | head -n1
        
    - name: Configure Firmware Template
      run: |
        cd "$PADAVAN_DIR/trunk"
        
        TEMPLATE_FILE="configs/templates/NEWIFI3.config"
        echo "ç”Ÿæˆ Newifi3 é…ç½®æ¨¡æ¿..."
        
        # åˆ›å»ºåŸºç¡€é…ç½®
        cat > "$TEMPLATE_FILE" <<'EOF'
        ### åŸºç¡€ç¡¬ä»¶é…ç½® ###
        CONFIG_VENDOR=ralink
        CONFIG_PRODUCT=MT7621
        CONFIG_LINUXDIR=linux-3.4.x
        
        ### è®¾å¤‡æ ‡è¯† ###
        CONFIG_FIRMWARE_PRODUCT_ID="NEWIFI3"
        CONFIG_FIRMWARE_CPU_MT7621=y
        CONFIG_FIRMWARE_MEMORY_512M=y
        CONFIG_FIRMWARE_FLASH_32M=y
        
        ### ç¡¬ä»¶åŠŸèƒ½ ###
        CONFIG_FIRMWARE_ENABLE_USB=y
        CONFIG_FIRMWARE_ENABLE_SWAP=n
        
        ### ç½‘ç»œæ ¸å¿ƒ ###
        CONFIG_FIRMWARE_ENABLE_IPV6=y
        CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y
        
        ### æ— çº¿é©±åŠ¨ ###
        CONFIG_FIRMWARE_WIFI2_DRIVER=3.0
        CONFIG_FIRMWARE_WIFI5_DRIVER=3.0
        
        ### SSH/FTP ###
        CONFIG_FIRMWARE_INCLUDE_DROPBEAR=y
        CONFIG_FIRMWARE_INCLUDE_SFTP=y
        CONFIG_FIRMWARE_INCLUDE_HTTPS=y
        
        ### ç¦ç”¨éå¿…è¦ç»„ä»¶ (ç²¾ç®€å›ºä»¶) ###
        CONFIG_FIRMWARE_INCLUDE_ARIA=n
        CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n
        CONFIG_FIRMWARE_INCLUDE_WGET=n
        CONFIG_FIRMWARE_INCLUDE_CURL=n
        CONFIG_FIRMWARE_INCLUDE_TCPDUMP=n
        
        ### VPN ç»„ä»¶ (å…¨éƒ¨ç¦ç”¨) ###
        CONFIG_FIRMWARE_INCLUDE_OPENVPN=n
        CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n
        CONFIG_FIRMWARE_INCLUDE_SSSERVER=n
        CONFIG_FIRMWARE_INCLUDE_TROJAN=n
        CONFIG_FIRMWARE_INCLUDE_V2RAY=n
        CONFIG_FIRMWARE_INCLUDE_XRAY=n
        CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_SERVER=n
        CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_CLIENT=n
        CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_CMD=n
        
        ### å…¶ä»–å·¥å…· ###
        CONFIG_FIRMWARE_INCLUDE_TTYD=n
        CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n
        CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n
        CONFIG_FIRMWARE_INCLUDE_SRELAY=n
        CONFIG_FIRMWARE_INCLUDE_TUNSAFE=n
        CONFIG_FIRMWARE_INCLUDE_WIREGUARD=n
        EOF

        echo "âœ“ é…ç½®æ¨¡æ¿ç”Ÿæˆå®Œæˆ: $TEMPLATE_FILE"
        echo "é…ç½®å†…å®¹é¢„è§ˆ:"
        head -n 15 "$TEMPLATE_FILE"
        
    - name: Build Firmware
      run: |
        cd "$PADAVAN_DIR/trunk"
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp -f configs/templates/NEWIFI3.config .config
        
        echo "=========================================="
        echo "å¼€å§‹ç¼–è¯‘ Padavan 3.4 å›ºä»¶"
        echo "=========================================="
        
        # æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©
        make clean
        
        # é˜¶æ®µ 1: ç¼–è¯‘åŸºç¡€åº“ (å…³é”®æ­¥éª¤)
        echo ""
        echo "[é˜¶æ®µ 1/2] ç¼–è¯‘å·¥å…·å’Œåº“..."
        if ! fakeroot make libs 2>&1 | tee "$WORK_ROOT/build-libs.log"; then
          echo "âŒ é”™è¯¯: åº“ç¼–è¯‘å¤±è´¥"
          echo "æŸ¥çœ‹æ—¥å¿—: $WORK_ROOT/build-libs.log"
          tail -n 50 "$WORK_ROOT/build-libs.log"
          exit 1
        fi
        
        echo "âœ“ åº“ç¼–è¯‘å®Œæˆ"
        
        # é˜¶æ®µ 2: ç¼–è¯‘å®Œæ•´å›ºä»¶
        echo ""
        echo "[é˜¶æ®µ 2/2] ç¼–è¯‘å›ºä»¶é•œåƒ..."
        if ! fakeroot ./build_firmware NEWIFI3 2>&1 | tee "$WORK_ROOT/build-firmware.log"; then
          echo "âŒ é”™è¯¯: å›ºä»¶ç¼–è¯‘å¤±è´¥"
          echo "æŸ¥çœ‹æ—¥å¿—: $WORK_ROOT/build-firmware.log"
          tail -n 100 "$WORK_ROOT/build-firmware.log"
          exit 1
        fi
        
        echo ""
        echo "=========================================="
        echo "âœ“ ç¼–è¯‘æˆåŠŸå®Œæˆ!"
        echo "=========================================="
        
        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        if [ -d "images" ] && [ "$(ls -A images/*.trx 2>/dev/null)" ]; then
          echo "å›ºä»¶æ–‡ä»¶:"
          ls -lh images/*.trx
        else
          echo "âŒ è­¦å‘Š: æœªæ‰¾åˆ°å›ºä»¶é•œåƒæ–‡ä»¶"
          exit 1
        fi
        
    - name: Organize Build Artifacts
      run: |
        mkdir -p "$WORK_ROOT/firmware"
        
        # å¤åˆ¶å›ºä»¶æ–‡ä»¶
        cp -v "$PADAVAN_DIR/trunk/images"/*.trx "$WORK_ROOT/firmware/"
        
        # å¤åˆ¶ç¼–è¯‘æ—¥å¿— (ç”¨äºè°ƒè¯•)
        if [ "${{ inputs.enable_debug }}" == "true" ]; then
          cp -v "$WORK_ROOT"/*.log "$WORK_ROOT/firmware/" 2>/dev/null || true
        fi
        
        # ç”Ÿæˆå›ºä»¶ä¿¡æ¯æ–‡ä»¶
        cat > "$WORK_ROOT/firmware/build-info.txt" <<EOF
        å›ºä»¶ç¼–è¯‘ä¿¡æ¯
        ==================
        æœºå‹: Newifi3 D2
        ç‰ˆæœ¬: Padavan 3.4 (hanwckf)
        å†…æ ¸: Linux 3.4.x
        ç¼–è¯‘æ—¶é—´: ${{ env.BUILD_DATE }}
        ç¼–è¯‘ç³»ç»Ÿ: Ubuntu 22.04
        ç¡¬ä»¶åŠ é€Ÿ: Flow Offload (å·²å¯ç”¨)
        
        æ–‡ä»¶åˆ—è¡¨:
        $(ls -lh "$WORK_ROOT/firmware"/*.trx | awk '{print $9, $5}')
        EOF

        cat "$WORK_ROOT/firmware/build-info.txt"
        echo "FIRMWARE_PATH=$WORK_ROOT/firmware" >> $GITHUB_ENV
        
    - name: Upload to GitHub Releases
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: newifi3-3.4-${{ env.BUILD_DATE }}
        name: "Newifi3 D2 Padavan 3.4 (${{ env.BUILD_DATE }})"
        body: |
          ## ğŸ“¦ Newifi3 D2 å›ºä»¶ - Padavan 3.4
          
          ### åŸºæœ¬ä¿¡æ¯
          - **æœºå‹**: Newifi3 D2 (NEWIFI3)
          - **å†…æ ¸ç‰ˆæœ¬**: Linux 3.4.x
          - **ç¼–è¯‘æ—¶é—´**: ${{ env.BUILD_DATE }}
          - **æºç åˆ†æ”¯**: hanwckf/rt-n56u (master)
          - **ç¼–è¯‘ç¯å¢ƒ**: Ubuntu 22.04 (GitHub Actions)
          
          ### åŠŸèƒ½ç‰¹æ€§
          - âœ… ç¡¬ä»¶åŠ é€Ÿ: Flow Offload å·²å¯ç”¨
          - âœ… IPv6 å…¨é¢æ”¯æŒ
          - âœ… SSH/SFTP/HTTPS
          - âœ… ç²¾ç®€ç‰ˆæœ¬ (æ—  VPN/ä¸‹è½½å·¥å…·)
          - âœ… æ— çº¿é©±åŠ¨: MT7603E (2.4G) + MT7612E (5G)
          
          ### åˆ·æœºè¯´æ˜
          1. è¿›å…¥ Breed/U-Boot æ§åˆ¶å°
          2. é€‰æ‹©å›ºä»¶æ›´æ–°
          3. ä¸Šä¼  `.trx` æ–‡ä»¶
          4. ç­‰å¾…åˆ·å†™å®Œæˆåé‡å¯
          
          ### é»˜è®¤è®¾ç½®
          - IP: 192.168.2.1
          - ç”¨æˆ·å: admin
          - å¯†ç : admin
          
          > âš ï¸ é¦–æ¬¡åˆ·æœºåå»ºè®®æ¢å¤å‡ºå‚è®¾ç½®
        files: |
          ${{ env.FIRMWARE_PATH }}/*.trx
          ${{ env.FIRMWARE_PATH }}/build-info.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Build Logs (if debug enabled)
      if: inputs.enable_debug == true
      uses: actions/upload-artifact@v3
      with:
        name: build-logs-${{ env.BUILD_DATE }}
        path: ${{ env.WORK_ROOT }}/*.log
        retention-days: 7
