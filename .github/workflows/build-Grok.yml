name: Build Newifi3 D2 Padavan (Grok 4.1)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: '固件版本(已锁定为3.4)'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (hanwckf - Stable/Legacy)'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Environment
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y \
          libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo
        sudo apt-get clean

        # 检查 ncurses5 是否可用
        if ! dpkg -l | grep libncurses5; then
          echo "Warning: libncurses5 not found! 请检查系统apt源。"
          exit 1
        fi

    - name: Run Compilation Logic
      run: |
        set -e
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p "$WORK_DIR"
        TOOLCHAIN_DIR="$WORK_DIR/toolchain-mipsel"

        CURRENT_DATE=$(date +%Y%m%d)
        echo "DATE=$CURRENT_DATE" >> $GITHUB_ENV

        # 固定 3.4 源码
        REPO_URL="https://github.com/hanwckf/rt-n56u.git"
        REPO_BRANCH="master"
        echo "Selected Version: 3.4 (hanwckf)"
        echo "BUILD_VER=3.4" >> $GITHUB_ENV
        TARGET_PROFILE="NEWIFI3"
        KERNEL_DIR_NAME="linux-3.4.x"
        
        echo "Cloning source code..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL "$WORK_DIR"

        # -------- 3.4 修复包 --------
        echo "Applying strict fixes for 3.4..."
        MKSQ_MAKEFILE="$WORK_DIR/trunk/tools/mksquashfs_xz/Makefile"
        if [ -f "$MKSQ_MAKEFILE" ]; then
            sed -i 's/.\/configure/.\/configure --disable-nls/g' "$MKSQ_MAKEFILE"
        fi
        XZ_SRC="$WORK_DIR/trunk/tools/mksquashfs_xz/xz-5.2.4"
        if [ -f "$XZ_SRC/Makefile.in" ]; then
            sed -i 's/SUBDIRS.*=.*/SUBDIRS = src/g' "$XZ_SRC/Makefile.in"
        fi
        E2FS_CFG="$WORK_DIR/trunk/user/e2fsprogs/configure"
        if [ -f "$E2FS_CFG" ]; then
            sed -i 's/AM_GNU_GETTEXT(external)/# AM_GNU_GETTEXT(external)/g' "$E2FS_CFG"
            sed -i 's/AM_GNU_GETTEXT_VERSION/# AM_GNU_GETTEXT_VERSION/g' "$E2FS_CFG"
            touch "$E2FS_CFG"
        fi
        DROPBEAR_MK="$WORK_DIR/trunk/user/dropbear/Makefile"
        if [ -f "$DROPBEAR_MK" ]; then
            sed -i 's/autoreconf -v;//g' "$DROPBEAR_MK"
            sed -i -E 's/CC\s*=\s*\$\(CC\)//g' "$DROPBEAR_MK"
            sed -i -E 's/CFLAGS\s*=\s*\$\(CFLAGS\)//g' "$DROPBEAR_MK"
            sed -i -E 's/LDFLAGS\s*=\s*\$\(LDFLAGS\)//g' "$DROPBEAR_MK"
            sed -i 's|./configure|export CC="$(CC)"; export CFLAGS="$(CFLAGS)"; export LDFLAGS="$(LDFLAGS)"; export LIBS="-lz -lcrypt"; ./configure|g' "$DROPBEAR_MK"
        fi
        
        # -------- 注入配置 --------
        cd "$WORK_DIR/trunk/configs/templates"
        echo "Injecting FULL Standard Config for $TARGET_PROFILE..."
        echo "CONFIG_VENDOR=ralink" > "$TARGET_PROFILE.config"
        echo "CONFIG_PRODUCT=MT7621" >> "$TARGET_PROFILE.config"
        echo "CONFIG_LINUXDIR=$KERNEL_DIR_NAME" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_PRODUCT_ID=\"NEWIFI3\"" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_CPU_MT7621=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_MEMORY_512M=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_FLASH_32M=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_ENABLE_USB=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_INCLUDE_HTTPS=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_INCLUDE_SFTP=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_INCLUDE_DROPBEAR=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_WIFI2_DRIVER=3.0" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_WIFI5_DRIVER=3.0" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_ENABLE_IPV6=y" >> "$TARGET_PROFILE.config"
        
        cd "$WORK_DIR/trunk"
        TEMPLATE_PATH="configs/templates/$TARGET_PROFILE.config"

        # -------- 准备 Toolchain --------
        echo "Preparing Toolchain..."
        cd "$TOOLCHAIN_DIR"
        sh dl_toolchain.sh
        
        echo "Setting up symlink for toolchain..."
        sudo mkdir -p /opt/rt-n56u
        sudo ln -sf "$TOOLCHAIN_DIR/toolchain-3.4.x" /opt/rt-n56u/toolchain-mipsel
        sudo chmod -R 755 /opt/rt-n56u/toolchain-mipsel || true
        
        export PATH="/opt/rt-n56u/toolchain-mipsel/bin:$PATH"
        if ! command -v mipsel-linux-uclibc-gcc &> /dev/null; then
            echo "ERROR: Toolchain setup failed! 若提示glibc错误请考虑切换到较旧 LTS Runner。"
            exit 1
        fi

        # -------- 修改配置 --------
        cd "$WORK_DIR/trunk"
        echo "Customizing $TEMPLATE_PATH..."
        sed -i '/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD/d' "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y" >> "$TEMPLATE_PATH"
        for FEAT in ARIA TRANSMISSION WGET OPENVPN SHADOWSOCKS TROJAN V2RAY XRAY SOFTETHERVPN; do
          sed -i "/CONFIG_FIRMWARE_INCLUDE_${FEAT}/d" "$TEMPLATE_PATH"
        done
        echo "CONFIG_FIRMWARE_INCLUDE_ARIA=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_WGET=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_OPENVPN=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_SSSERVER=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_TROJAN=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_V2RAY=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_XRAY=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_SERVER=n" >> "$TEMPLATE_PATH"

        # -------- 开始编译 --------
        rm -f .config
        cp -f "$TEMPLATE_PATH" .config
        echo "Starting Pre-build (Libs)..."
        export LC_ALL=C
        make clean
        fakeroot make libs || exit 1
        echo "Starting Full Build..."
        fakeroot ./build_firmware "$TARGET_PROFILE"

    - name: Organize Artifacts
      run: |
        mkdir -p ./output_firmware
        cp ${{ github.workspace }}/padavan/trunk/images/*.trx ./output_firmware/
        echo "FIRMWARE_PATH=./output_firmware" >> $GITHUB_ENV

    - name: Upload Firmware to Releases
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.DATE }}-newifi3-${{ env.BUILD_VER }}
        name: Newifi3 D2 Padavan ${{ env.BUILD_VER }} (${{ env.DATE }})
        body: |
          自动构建固件 (Newifi3 D2)
          - 机型: Newifi3 D2 (NEWIFI3)
          - 版本: Padavan ${{ env.BUILD_VER }}
          - 编译日期: ${{ env.DATE }}
          - 插件: 纯净版
          - 硬件加速: 开启 (Flow Offload)
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
