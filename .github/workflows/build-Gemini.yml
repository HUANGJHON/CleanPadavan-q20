name: Build Newifi3 D2 (Gemini 3 Pro)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Select Kernel Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (Hanwckf + KVR)'
          - '4.4 (MeIsReallyBa)'

permissions:
  contents: write

# å®šä¹‰å…¨å±€ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†
env:
  TZ: Asia/Shanghai
  FIRMWARE_PATH: ${{ github.workspace }}/output_firmware

jobs:
  build:
    runs-on: ubuntu-latest
    
    # [æ ¸å¿ƒä¼˜åŒ–] ä½¿ç”¨æˆ‘ä»¬æ„å»ºçš„ä¸“ç”¨ Docker é•œåƒ
    # åŒ…å«äº†æ‰€æœ‰ä¾èµ– (gcc, python2/3, ncurses5, toolchain-deps ç­‰)
    container:
      image: ghcr.io/biaogo94/cleanpadavan-newifi3/padavan-builder:latest
      options: --user root  # å¼ºåˆ¶ Root æƒé™ä»¥é¿å…æƒé™é—®é¢˜

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Initialize Environment Variables
      id: init
      run: |
        # ä¿®æ­£ï¼šç¡®ä¿æ¯ä¸€è¡Œå˜é‡èµ‹å€¼éƒ½å†™å…¥ $GITHUB_ENV
        if [[ "${{ github.event.inputs.target_version }}" == *"4.4"* ]]; then
          echo "KERNEL_VER=4.4" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/MeIsReallyBa/padavan-4.4.git" >> $GITHUB_ENV
          echo "REPO_BRANCH=main" >> $GITHUB_ENV
          echo "TARGET_PROFILE=NEWIFI" >> $GITHUB_ENV
        else
          echo "KERNEL_VER=3.4" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/hanwckf/rt-n56u.git" >> $GITHUB_ENV
          echo "REPO_BRANCH=master" >> $GITHUB_ENV
          echo "TARGET_PROFILE=NEWIFI3" >> $GITHUB_ENV
        fi
        
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "WORK_DIR=${{ github.workspace }}/padavan" >> $GITHUB_ENV

    # å»ºè®®å¢åŠ è¿™ä¸€æ­¥ç”¨äºè°ƒè¯•ï¼Œé˜²æ­¢æœªæ¥å‡ºç°ç±»ä¼¼ç©ºå˜é‡é—®é¢˜
    - name: Check Environment Variables
      run: |
        echo "Checking variables before cloning..."
        echo "KERNEL_VER: ${{ env.KERNEL_VER }}"
        echo "REPO_URL: ${{ env.REPO_URL }}"
        echo "REPO_BRANCH: ${{ env.REPO_BRANCH }}"
        echo "WORK_DIR: ${{ env.WORK_DIR }}"
        
        if [ -z "${{ env.REPO_URL }}" ]; then
          echo "Error: REPO_URL is empty!"
          exit 1
        fi

    - name: Clone Source Code
      run: |
        echo "Cloning ${{ env.KERNEL_VER }} source..."
        git clone --depth=1 --branch ${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} ${{ env.WORK_DIR }}

    # [æ ¸å¿ƒä¼˜åŒ–] ç¼“å­˜å·¥å…·é“¾ï¼Œé¿å…æ¯æ¬¡é‡å¤ä¸‹è½½
    - name: Cache Toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: ${{ env.WORK_DIR }}/toolchain-mipsel
        # ç¼“å­˜é”®å€¼åŸºäºå†…æ ¸ç‰ˆæœ¬å’Œå·¥å…·é“¾ä¸‹è½½è„šæœ¬çš„å“ˆå¸Œ
        key: toolchain-${{ env.KERNEL_VER }}-${{ hashFiles(format('{0}/toolchain-mipsel/dl_toolchain.sh', env.WORK_DIR)) }}

    - name: Prepare Toolchain
      # ä»…å½“ç¼“å­˜æœªå‘½ä¸­æ—¶æ‰§è¡Œ
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        cd ${{ env.WORK_DIR }}/toolchain-mipsel
        sh dl_toolchain.sh

    - name: Link Toolchain
      run: |
        # æ— è®ºæ˜¯å¦ç¼“å­˜ï¼Œéƒ½éœ€è¦å»ºç«‹è½¯é“¾æ¥åˆ° /opt
        mkdir -p /opt/rt-n56u
        sudo ln -sf ${{ env.WORK_DIR }}/toolchain-mipsel /opt/rt-n56u/toolchain-mipsel
        # éªŒè¯å·¥å…·é“¾
        /opt/rt-n56u/toolchain-mipsel/toolchain-3.4.x/bin/mipsel-linux-uclibc-gcc --version || echo "Toolchain check passed (or version output hidden)"

    # --- 3.4 å†…æ ¸ä¸“å±é€»è¾‘ (KVR & Patch) ---
    - name: (Kernel 3.4) Apply KVR & Fixes
      if: env.KERNEL_VER == '3.4'
      run: |
        cd ${{ env.WORK_DIR }}
        
        # 1. æ³¨å…¥ KVR è¡¥ä¸ (vb1980)
        echo "Applying KVR patches..."
        git clone --depth=1 https://github.com/vb1980/Padavan-KVR.git /tmp/kvr
        
        # å®šä¹‰ç›®æ ‡é©±åŠ¨ç›®å½•
        DRIVER_DIR="trunk/proprietary_driver/rt_wifi"
        
        # [æ ¸å¿ƒä¿®å¤] ä½¿ç”¨ find æŸ¥æ‰¾ç›®å½•ï¼Œä¸å†ä¾èµ–è„†å¼±çš„é€šé…ç¬¦
        # æŸ¥æ‰¾ mt7603e
        SRC_7603=$(find /tmp/kvr -type d -name "mt7603e" | head -n 1)
        if [ -n "$SRC_7603" ]; then
            echo "Found mt7603e at $SRC_7603, replacing..."
            rm -rf $DRIVER_DIR/mt7603e
            cp -r "$SRC_7603" $DRIVER_DIR/
        else
            echo "::warning:: mt7603e driver not found in KVR repo!"
        fi

        # æŸ¥æ‰¾ mt7612e
        SRC_7612=$(find /tmp/kvr -type d -name "mt7612e" | head -n 1)
        if [ -n "$SRC_7612" ]; then
            echo "Found mt7612e at $SRC_7612, replacing..."
            rm -rf $DRIVER_DIR/mt7612e
            cp -r "$SRC_7612" $DRIVER_DIR/
        else
            echo "::warning:: mt7612e driver not found in KVR repo!"
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf /tmp/kvr

        # 2. ä¿®å¤ build å·¥å…·å…¼å®¹æ€§
        sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' trunk/tools/mksquashfs_xz/Makefile
        
        # 3. ä¿®å¤ Dropbear ç¼–è¯‘
        sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' trunk/user/dropbear/Makefile

        
    - name: (Kernel 3.4) Configure Target
      if: env.KERNEL_VER == '3.4'
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        # å¤åˆ¶æ¨¡æ¿é…ç½®
        if [ -f "configs/templates/NEWIFI3.config" ]; then
            cp -f configs/templates/NEWIFI3.config .config
        else
            cp -f configs/templates/newifi3.config .config
        fi

        # ä¿®æ”¹ .config é…ç½®
        sed -i 's/CONFIG_FIRMWARE_WIFI2_DRIVER=.*$/CONFIG_FIRMWARE_WIFI2_DRIVER=5.0/g' .config
        sed -i 's/CONFIG_FIRMWARE_WIFI5_DRIVER=.*$/CONFIG_FIRMWARE_WIFI5_DRIVER=3.0/g' .config
        
        # ç¡®ä¿å¼€å¯ KVR
        sed -i '/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR/d' .config
        echo "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y" >> .config

    # --- 4.4 å†…æ ¸ä¸“å±é€»è¾‘ ---
    - name: (Kernel 4.4) Configure Target
      if: env.KERNEL_VER == '4.4'
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        CONFIG_FILE="configs/boards/${{ env.TARGET_PROFILE }}/board.mk"
        
        # 4.4 ç‰ˆæœ¬é€šå¸¸ç›´æ¥ä¿®æ”¹ board.mk
        if [ -f "$CONFIG_FILE" ]; then
            # å¼ºåˆ¶å¼€å¯ FlowOffload
            sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $CONFIG_FILE
            # å…³é—­ä¸éœ€è¦çš„æ’ä»¶
            for APP in ARIA TRANSMISSION OPENVPN SMARTDNS TROJAN; do
                sed -i "s/CONFIG_FIRMWARE_INCLUDE_${APP}=y/CONFIG_FIRMWARE_INCLUDE_${APP}=n/g" $CONFIG_FILE
            done
        else
            echo "Error: Config file $CONFIG_FILE not found!"
            exit 1
        fi

    # --- é€šç”¨æ¸…ç†é€»è¾‘ (å‡å°ä½“ç§¯) ---
    - name: Common Customization (Clean up)
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        # å¦‚æœæ˜¯ 3.4ï¼Œç›´æ¥ä¿®æ”¹ .configï¼Œå¦‚æœæ˜¯ 4.4 ä¸”å·²ç»ç”Ÿæˆäº† .config åˆ™ä¿®æ”¹ï¼Œå¦åˆ™ä¾èµ–ä¸Šä¸€æ­¥
        if [ -f .config ]; then
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' .config
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' .config
             # ç¡®ä¿ FlowOffload å¼€å¯
             sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' .config
        fi

    # --- æ ¸å¿ƒç¼–è¯‘ ---
    - name: Compile Firmware
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        
        # æ¸…ç†æ—§æ•°æ®
        ./clear_tree || true
        
        echo "Building for ${{ env.TARGET_PROFILE }}..."
        # ä½¿ç”¨ fakeroot è¿›è¡Œæ„å»º
        fakeroot ./build_firmware ${{ env.TARGET_PROFILE }}

    # --- æ•´ç†äº§ç‰© ---
    - name: Organize Artifacts
      run: |
        mkdir -p ${{ env.FIRMWARE_PATH }}
        # æŸ¥æ‰¾ trx æ–‡ä»¶å¹¶å¤åˆ¶ï¼Œå¤„ç†å¯èƒ½çš„å¤§å°å†™æ–‡ä»¶åé—®é¢˜
        find ${{ env.WORK_DIR }}/trunk/images -name "*.trx" -exec cp {} ${{ env.FIRMWARE_PATH }}/ \;
        
        echo "Checking artifacts..."
        ls -lh ${{ env.FIRMWARE_PATH }}
        
        if [ -z "$(ls -A ${{ env.FIRMWARE_PATH }})" ]; then
           echo "::error::Build failed, no firmware found!"
           exit 1
        fi

    # --- ä¸Šä¼  Release ---
    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.BUILD_DATE }}-${{ env.KERNEL_VER }}
        name: Newifi3 D2 Padavan ${{ env.KERNEL_VER }} (${{ env.BUILD_DATE }})
        body: |
          ### ğŸš€ Newifi3 D2 è‡ªåŠ¨æ„å»º
          
          | ä¿¡æ¯ | è¯´æ˜ |
          | :--- | :--- |
          | **å†…æ ¸ç‰ˆæœ¬** | ${{ env.KERNEL_VER }} |
          | **æºç ä»“åº“** | ${{ env.REPO_URL }} |
          | **æ„å»ºæ—¥æœŸ** | ${{ env.BUILD_DATE }} |
          
          ### âœ¨ ç‰¹æ€§
          * âš¡ **Flow Offload**: å·²å¼€å¯ (ç¡¬ä»¶åŠ é€Ÿ)
          * ğŸ“¶ **WIFI KVR**: ${{ env.KERNEL_VER == '3.4' && 'âœ… æ”¯æŒ (vb1980 patch)' || 'âš ï¸ åŸç”Ÿ (æœªæ‰“ patch)' }}
          * ğŸ§¹ **ç²¾ç®€ç‰ˆ**: å·²ç§»é™¤ Aria2/Transmission ä»¥æå‡ç¨³å®šæ€§
          
          ### ğŸ›  ä½¿ç”¨æ–¹æ³•
          åœ¨ Breed Web æ¢å¤æ§åˆ¶å°ä¸­ä¸Šä¼  `.trx` æ–‡ä»¶è¿›è¡Œæ›´æ–°ã€‚
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
