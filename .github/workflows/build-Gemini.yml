name: Build Newifi3 D2 Padavan (Gemini 3 Pro)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: '选择固件版本 / Firmware Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (hanwckf - Stable/Legacy)'
          - '4.4 (MeIsReallyBa - Kernel 4.4)'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo
        sudo apt-get clean

    - name: Run Compilation Logic
      run: |
        # =======================================================
        # 1. 初始化设置
        # =======================================================
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p $WORK_DIR
        
        CURRENT_DATE=$(date +%Y%m%d)
        echo "DATE=$CURRENT_DATE" >> $GITHUB_ENV
        
        # 设定源
        if [[ "${{ inputs.target_version }}" == *"3.4"* ]]; then
          REPO_URL="https://github.com/hanwckf/rt-n56u.git"
          REPO_BRANCH="master"
          echo "Build Target: 3.4 (hanwckf)"
          echo "BUILD_VER=3.4" >> $GITHUB_ENV
        else
          REPO_URL="https://github.com/MeIsReallyBa/padavan-4.4.git"
          REPO_BRANCH="main"
          echo "Build Target: 4.4 (MeIsReallyBa)"
          echo "BUILD_VER=4.4" >> $GITHUB_ENV
        fi
        
        # =======================================================
        # 2. 拉取源码
        # =======================================================
        echo "Cloning source code from $REPO_URL ..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL $WORK_DIR
        
        # =======================================================
        # 3. 兼容性修复 (仅针对 3.4 版本)
        # =======================================================
        if [[ "${{ inputs.target_version }}" == *"3.4"* ]]; then
            echo "Running fixes for 3.4..."
            # 修复 xz 编译问题
            sed -i 's/ po / /g' "$WORK_DIR/trunk/tools/mksquashfs_xz/xz-5.2.4/Makefile.in" 2>/dev/null || true
            sed -i 's/ po / /g' "$WORK_DIR/trunk/tools/mksquashfs_xz/xz-5.2.4/Makefile" 2>/dev/null || true
            
            # 修复 e2fsprogs 配置
            if [ -d "$WORK_DIR/trunk/user/e2fsprogs" ]; then
                cd $WORK_DIR/trunk/user/e2fsprogs
                rm -f aclocal.m4
                autoreconf -i -v -f
            fi
        fi

        # =======================================================
        # 4. 准备 Toolchain
        # =======================================================
        cd $WORK_DIR/toolchain-mipsel
        # 4.4 版本通常需要清理一下旧的链接以防万一
        sh dl_toolchain.sh
        
        # =======================================================
        # 5. 【终极修复】智能搜索 Newifi3 配置文件
        # =======================================================
        cd $WORK_DIR/trunk
        
        echo "Searching for Newifi3 config file..."
        
        # 使用 find 命令模糊查找，忽略大小写 (-iname)，找到包含 newifi3 的 .config 文件
        # 结果通常是: configs/templates/newifi3.config 或 configs/templates/NEWIFI3.config
        CONF_PATH=$(find configs/templates -type f -iname "*newifi3.config" | head -n 1)
        
        # 如果没找到 newifi3，尝试找 d2
        if [ -z "$CONF_PATH" ]; then
            CONF_PATH=$(find configs/templates -type f -iname "*d2.config" | head -n 1)
        fi

        # 检查是否真的找到了
        if [ -z "$CONF_PATH" ]; then
            echo "FATAL ERROR: Could not find any config file matching 'newifi3' or 'd2'!"
            echo "Listing all available templates for debugging:"
            ls -R configs/templates
            exit 1
        fi
        
        # 提取文件名（不带路径和后缀），例如 "newifi3" 或 "NEWIFI3"
        TARGET_DEVICE=$(basename "$CONF_PATH" .config)
        
        echo "✅ FOUND CONFIG: $CONF_PATH"
        echo "✅ TARGET DEVICE ID: $TARGET_DEVICE"
        
        TEMPLATE_PATH="configs/templates/$TARGET_DEVICE.config"

        # =======================================================
        # 6. 修改配置 (插件净化)
        # =======================================================
        echo "Customizing $TEMPLATE_PATH..."
        
        # 4.4 和 3.4 通用的清理逻辑
        # 使用通配符匹配可能存在的空格或不同写法
        sed -i 's/^CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' $TEMPLATE_PATH
        sed -i 's/^CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' $TEMPLATE_PATH
        sed -i 's/^CONFIG_FIRMWARE_INCLUDE_WGET=y/CONFIG_FIRMWARE_INCLUDE_WGET=n/g' $TEMPLATE_PATH
        sed -i 's/^CONFIG_FIRMWARE_INCLUDE_OPENVPN=y/CONFIG_FIRMWARE_INCLUDE_OPENVPN=n/g' $TEMPLATE_PATH
        
        # MeIsReallyBa 4.4 源码特有的插件宏可能不同，这里尝试通杀
        sed -i 's/^CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n/g' $TEMPLATE_PATH
        sed -i 's/^CONFIG_FIRMWARE_INCLUDE_TROJAN=y/CONFIG_FIRMWARE_INCLUDE_TROJAN=n/g' $TEMPLATE_PATH
        sed -i 's/^CONFIG_FIRMWARE_INCLUDE_V2RAY=y/CONFIG_FIRMWARE_INCLUDE_V2RAY=n/g' $TEMPLATE_PATH
        
        # 启用 Flow Offload (硬件加速)
        sed -i 's/^CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $TEMPLATE_PATH
        if ! grep -q "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD" $TEMPLATE_PATH; then
             echo "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y" >> $TEMPLATE_PATH
        fi

        # =======================================================
        # 7. 开始编译
        # =======================================================
        # 生成 .config
        cp -f $TEMPLATE_PATH .config
        
        echo "Running build_firmware..."
        # 注意：4.4 的脚本对参数大小写可能敏感，但我们上面已经动态提取了正确的大小写 ID
        fakeroot ./build_firmware $TARGET_DEVICE
        
    - name: Organize Artifacts
      run: |
        mkdir -p ./output_firmware
        cp ${{ github.workspace }}/padavan/trunk/images/*.trx ./output_firmware/
        echo "FIRMWARE_PATH=./output_firmware" >> $GITHUB_ENV

    - name: Upload Firmware to Releases
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.DATE }}-newifi3-${{ env.BUILD_VER }}
        name: Newifi3 D2 Padavan ${{ env.BUILD_VER }} (${{ env.DATE }})
        body: |
          自动构建固件 (Newifi3 D2)
          - 机型: Newifi3 D2 (NEWIFI3)
          - 版本: Padavan ${{ env.BUILD_VER }}
          - 编译日期: ${{ env.DATE }}
          - 插件: 纯净版 (移除 Aria2/Transmission 等重型应用)
          - 硬件加速: 开启 (Flow Offload)
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
