name: Build Newifi3 D2 (Gemini 3 Pro)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Select Kernel Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (Hanwckf + KVR)'
          - '4.4 (MeIsReallyBa)'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    
    container:
      image: ghcr.io/biaogo94/cleanpadavan-newifi3/padavan-builder:latest
      options: --user root

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    # [关键修复] 使用 case 语句确保 4.4 版本变量(分支、URL)正确赋值
    - name: Initialize Environment Variables
      id: init
      run: |
        INPUT_VER="${{ github.event.inputs.target_version }}"
        echo "User Input: $INPUT_VER"

        case "$INPUT_VER" in
          *"4.4"*)
            echo "✅ Mode: Kernel 4.4 (MeIsReallyBa)"
            echo "KERNEL_VER=4.4" >> $GITHUB_ENV
            echo "REPO_URL=https://github.com/MeIsReallyBa/padavan-4.4.git" >> $GITHUB_ENV
            echo "REPO_BRANCH=main" >> $GITHUB_ENV
            echo "TARGET_PROFILE=NEWIFI" >> $GITHUB_ENV
            ;;
          *)
            echo "☑️ Mode: Kernel 3.4 (Hanwckf)"
            echo "KERNEL_VER=3.4" >> $GITHUB_ENV
            echo "REPO_URL=https://github.com/hanwckf/rt-n56u.git" >> $GITHUB_ENV
            echo "REPO_BRANCH=master" >> $GITHUB_ENV
            echo "TARGET_PROFILE=CR660x" >> $GITHUB_ENV
            ;;
        esac
        
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "WORK_DIR=${{ github.workspace }}/padavan" >> $GITHUB_ENV

    # 拉取源码
    - name: Clone Source Code
      run: |
        echo "Cloning form ${{ env.REPO_URL }} (Branch: ${{ env.REPO_BRANCH }})..."
        git clone --depth=1 --branch ${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} ${{ env.WORK_DIR }}

    # [优化] 缓存 Key 改用纯文本版本号，更稳健
    - name: Cache Toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: ${{ env.WORK_DIR }}/toolchain-mipsel
        key: pkg-toolchain-${{ env.KERNEL_VER }}

    # [逻辑完善] 优先使用自带脚本，自带脚本不存在才手动下载
    - name: Prepare Toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        mkdir -p ${{ env.WORK_DIR }}/toolchain-mipsel
        cd ${{ env.WORK_DIR }}/toolchain-mipsel
        
        echo "Checking for downloader script..."
        ls -lh dl_toolchain.sh || echo "Script not listed."

        if [ -f "dl_toolchain.sh" ]; then
            echo "✅ Script found! Executing dl_toolchain.sh..."
            sh dl_toolchain.sh
        else
            echo "⚠️ Script NOT found. Downloading toolchain manually (Fallback)..."
            wget -O toolchain.tar.xz https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz
            tar -xvf toolchain.tar.xz
            rm -f toolchain.tar.xz
            
            if [ -d "toolchain-3.4.x" ]; then
                echo "✅ Toolchain extracted."
            else
                echo "::error:: Toolchain failed to extract."
                exit 1
            fi
        fi

    - name: Link Toolchain
      run: |
        mkdir -p /opt/rt-n56u
        sudo ln -sf ${{ env.WORK_DIR }}/toolchain-mipsel /opt/rt-n56u/toolchain-mipsel
        # 验证一下
        ls -l /opt/rt-n56u/toolchain-mipsel

    # --- 3.4 内核 KVR 逻辑 ---
    - name: (Kernel 3.4) Apply KVR & Fixes
      if: env.KERNEL_VER == '3.4'
      run: |
        cd ${{ env.WORK_DIR }}
        
        echo ">>> Applying KVR patches..."
        KVR_TEMP="/tmp/padavan_kvr"
        rm -rf $KVR_TEMP
        git clone --depth=1 https://github.com/vb1980/Padavan-KVR.git $KVR_TEMP
        
        DEST_DRIVER_DIR="${{ env.WORK_DIR }}/trunk/proprietary/rt_wifi"
        SRC_MT7915=$(find $KVR_TEMP -type d -name "mt7915*" -print -quit)
        
        if [ -n "$SRC_MT7915" ]; then 
            rm -rf $DEST_DRIVER_DIR/mt7915
            cp -r "$SRC_MT7915" $DEST_DRIVER_DIR/mt7915
        fi
        
        rm -rf $KVR_TEMP
        
        sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' trunk/tools/mksquashfs_xz/Makefile
        sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' trunk/user/dropbear/Makefile

    - name: (Kernel 3.4) Configure Target
      if: env.KERNEL_VER == '3.4'
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        # 复制配置文件
        if [ -f "configs/templates/CR660x.config" ]; then
            cp -f configs/templates/CR660x.config .config
        else
            cp -f configs/templates/cr660x.config .config
        fi

        # 修改驱动版本和开启 KVR
        sed -i 's/CONFIG_FIRMWARE_WIFI2_DRIVER=.*$/CONFIG_FIRMWARE_WIFI2_DRIVER=7.3/g' .config
        sed -i 's/CONFIG_FIRMWARE_WIFI5_DRIVER=.*$/CONFIG_FIRMWARE_WIFI5_DRIVER=7.3/g' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR/d' .config
        echo "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y" >> .config

    # --- 4.4 内核配置逻辑 ---
    - name: (Kernel 4.4) Configure Target
      if: env.KERNEL_VER == '4.4'
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        CONFIG_FILE="configs/boards/${{ env.TARGET_PROFILE }}/board.mk"
        
        echo "Modifying config: $CONFIG_FILE"
        if [ -f "$CONFIG_FILE" ]; then
            sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $CONFIG_FILE
            for APP in ARIA TRANSMISSION OPENVPN SMARTDNS TROJAN; do
                sed -i "s/CONFIG_FIRMWARE_INCLUDE_${APP}=y/CONFIG_FIRMWARE_INCLUDE_${APP}=n/g" $CONFIG_FILE
            done
        else
            echo "::error:: Board Config file not found!"
            exit 1
        fi

    # --- 通用清理 ---
    - name: Common Customization
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        if [ -f .config ]; then
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' .config
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' .config
             sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' .config
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_RTL_SDR=y/CONFIG_FIRMWARE_INCLUDE_RTL_SDR=n/g' .config
        fi

    - name: Compile Firmware
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        ./clear_tree || true
        
        echo "Building..."
        fakeroot ./build_firmware ${{ env.TARGET_PROFILE }}
        
        if [ ! -f images/*.trx ]; then
            echo "::error:: Compilation failed! No .trx file generated."
            exit 1
        fi

    - name: Organize Artifacts
      run: |
        # 使用相对路径 output_firmware
        mkdir -p output_firmware
        find ${{ env.WORK_DIR }}/trunk/images -name "*.trx" -exec cp {} output_firmware/ \;
        ls -lh output_firmware/

    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.BUILD_DATE }}-${{ env.KERNEL_VER }}
        name: Newifi3 D2 Padavan ${{ env.KERNEL_VER }} (${{ env.BUILD_DATE }})
        body: |
           Newifi3 D2 Padavan Auto Build
           Kernel: ${{ env.KERNEL_VER }}
        # 相对路径匹配
        files: output_firmware/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
