name: Build Newifi3 D2 (Gemini 3 Pro)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Select Kernel Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (Hanwckf + KVR)'
          - '4.4 (MeIsReallyBa)'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai
  # 删除 FIRMWARE_PATH 环境变量，改用局部相对路径

jobs:
  build:
    runs-on: ubuntu-latest
    
    container:
      image: ghcr.io/biaogo94/cleanpadavan-newifi3/padavan-builder:latest
      options: --user root

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Initialize Environment Variables
      id: init
      run: |
        # 1. 先把输入赋值给一个 Shell 变量，避免插值语法错误
        INPUT_VER="${{ github.event.inputs.target_version }}"
        echo "Debug: User Input is [$INPUT_VER]"

        # 2. 使用 case 语句进行匹配，这是最稳健的写法
        case "$INPUT_VER" in
          *"4.4"*)
            echo "✅ Match: Switching to Kernel 4.4 (MeIsReallyBa)"
            echo "KERNEL_VER=4.4" >> $GITHUB_ENV
            echo "REPO_URL=https://github.com/MeIsReallyBa/padavan-4.4.git" >> $GITHUB_ENV
            echo "REPO_BRANCH=main" >> $GITHUB_ENV
            echo "TARGET_PROFILE=NEWIFI" >> $GITHUB_ENV
            ;;
          *)
            echo "☑️ Default: Switching to Kernel 3.4 (Hanwckf)"
            echo "KERNEL_VER=3.4" >> $GITHUB_ENV
            echo "REPO_URL=https://github.com/hanwckf/rt-n56u.git" >> $GITHUB_ENV
            echo "REPO_BRANCH=master" >> $GITHUB_ENV
            echo "TARGET_PROFILE=NEWIFI3" >> $GITHUB_ENV
            ;;
        esac
        
        # 3. 设置通用变量
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "WORK_DIR=${{ github.workspace }}/padavan" >> $GITHUB_ENV

    - name: Cache Toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: ${{ env.WORK_DIR }}/toolchain-mipsel
        key: toolchain-${{ env.KERNEL_VER }}-${{ hashFiles(format('{0}/toolchain-mipsel/dl_toolchain.sh', env.WORK_DIR)) }}

    - name: Prepare Toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        cd ${{ env.WORK_DIR }}/toolchain-mipsel
        sh dl_toolchain.sh

    - name: Link Toolchain
      run: |
        mkdir -p /opt/rt-n56u
        sudo ln -sf ${{ env.WORK_DIR }}/toolchain-mipsel /opt/rt-n56u/toolchain-mipsel

    - name: (Kernel 3.4) Apply KVR & Fixes
      if: env.KERNEL_VER == '3.4'
      run: |
        cd ${{ env.WORK_DIR }}
        
        echo ">>> Applying KVR patches..."
        KVR_TEMP="/tmp/padavan_kvr"
        rm -rf $KVR_TEMP
        git clone --depth=1 https://github.com/vb1980/Padavan-KVR.git $KVR_TEMP
        
        DEST_DRIVER_DIR="${{ env.WORK_DIR }}/trunk/proprietary_driver/rt_wifi"
        
        SRC_MT7603=$(find $KVR_TEMP -type d -name "mt7603e*" -print -quit)
        SRC_MT7612=$(find $KVR_TEMP -type d -name "mt7612e*" -print -quit)
        
        if [ -n "$SRC_MT7603" ]; then 
            echo "Replacing mt7603e..."
            rm -rf $DEST_DRIVER_DIR/mt7603e
            cp -r "$SRC_MT7603" $DEST_DRIVER_DIR/mt7603e
        fi
        
        if [ -n "$SRC_MT7612" ]; then 
            echo "Replacing mt7612e..."
            rm -rf $DEST_DRIVER_DIR/mt7612e
            cp -r "$SRC_MT7612" $DEST_DRIVER_DIR/mt7612e
        fi
        
        rm -rf $KVR_TEMP
        
        sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' trunk/tools/mksquashfs_xz/Makefile
        sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' trunk/user/dropbear/Makefile

    - name: (Kernel 3.4) Configure Target
      if: env.KERNEL_VER == '3.4'
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        if [ -f "configs/templates/NEWIFI3.config" ]; then
            cp -f configs/templates/NEWIFI3.config .config
        else
            cp -f configs/templates/newifi3.config .config
        fi

        sed -i 's/CONFIG_FIRMWARE_WIFI2_DRIVER=.*$/CONFIG_FIRMWARE_WIFI2_DRIVER=5.0/g' .config
        sed -i 's/CONFIG_FIRMWARE_WIFI5_DRIVER=.*$/CONFIG_FIRMWARE_WIFI5_DRIVER=3.0/g' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR/d' .config
        echo "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y" >> .config

    - name: (Kernel 4.4) Configure Target
      if: env.KERNEL_VER == '4.4'
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        CONFIG_FILE="configs/boards/${{ env.TARGET_PROFILE }}/board.mk"
        if [ -f "$CONFIG_FILE" ]; then
            sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $CONFIG_FILE
            for APP in ARIA TRANSMISSION OPENVPN SMARTDNS TROJAN; do
                sed -i "s/CONFIG_FIRMWARE_INCLUDE_${APP}=y/CONFIG_FIRMWARE_INCLUDE_${APP}=n/g" $CONFIG_FILE
            done
        fi

    - name: Common Customization
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        if [ -f .config ]; then
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' .config
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' .config
             sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' .config
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_RTL_SDR=y/CONFIG_FIRMWARE_INCLUDE_RTL_SDR=n/g' .config
        fi

    - name: Compile Firmware
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        ./clear_tree || true
        
        echo "Building..."
        fakeroot ./build_firmware ${{ env.TARGET_PROFILE }}
        
        # 检查是否真的生成了 TRX 文件
        if [ ! -f images/*.trx ]; then
            echo "::error:: Compilation failed! No .trx file generated."
            exit 1
        fi

    - name: Organize Artifacts
      run: |
        # 创建 output_firmware 目录（相对路径）
        mkdir -p output_firmware
        
        # 将生成的固件复制过去
        find ${{ env.WORK_DIR }}/trunk/images -name "*.trx" -exec cp {} output_firmware/ \;
        
        # 打印一下看看
        ls -lh output_firmware/

    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.BUILD_DATE }}-${{ env.KERNEL_VER }}
        name: Newifi3 D2 Padavan ${{ env.KERNEL_VER }} (${{ env.BUILD_DATE }})
        body: |
           Newifi3 D2 Padavan Auto Build
           Kernel: ${{ env.KERNEL_VER }}
        # 使用相对路径匹配，这在容器环境中是最稳的
        files: output_firmware/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
