name: Build Newifi3 D2 Padavan (Final Fix)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: '选择固件版本 / Firmware Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (hanwckf - Stable/Legacy)'
          - '4.4 (MeIsReallyBa - Kernel 4.4)'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo \
          libtirpc-dev automake autoconf
        sudo apt-get clean

    - name: Run Compilation Logic
      run: |
        # =======================================================
        # 1. 基础变量设置
        # =======================================================
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p $WORK_DIR
        TARGET_PROFILE="NEWIFI3"
        CURRENT_DATE=$(date +%Y%m%d)
        echo "DATE=$CURRENT_DATE" >> $GITHUB_ENV
        
        if [[ "${{ inputs.target_version }}" == *"3.4"* ]]; then
          REPO_URL="https://github.com/hanwckf/rt-n56u.git"
          REPO_BRANCH="master"
          echo "BUILD_VER=3.4" >> $GITHUB_ENV
        else
          REPO_URL="https://github.com/MeIsReallyBa/padavan-4.4.git"
          REPO_BRANCH="main"
          echo "BUILD_VER=4.4" >> $GITHUB_ENV
        fi
        
        # =======================================================
        # 2. 拉取源码
        # =======================================================
        echo "Cloning source code..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL $WORK_DIR
        
        # =======================================================
        # 3. 【关键修复】针对 Ubuntu 22.04 的补丁集
        # =======================================================
        
        # --- Fix A: 修复 xz/mksquashfs 的 po 目录编译失败 ---
        if [[ "${{ inputs.target_version }}" == *"3.4"* ]]; then
            cd $WORK_DIR/trunk/tools/mksquashfs_xz
            sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' Makefile
        fi
        
        # --- Fix B: 修复 Dropbear "configure: not found" 和 RPC 问题 ---
        # 这是导致你上一次失败的核心原因
        if [[ "${{ inputs.target_version }}" == *"3.4"* ]]; then
            echo "Patching Dropbear for Ubuntu 22.04..."
            cd $WORK_DIR/trunk/user/dropbear
            
            # 1. 找到源码目录 (如 dropbear-2019.78)
            DB_SRC_DIR=$(find . -maxdepth 1 -type d -name "dropbear-*" | head -n 1)
            
            if [ -d "$DB_SRC_DIR" ]; then
                # 2. 手动生成 configure 脚本 (解决 Error 127)
                cd "$DB_SRC_DIR"
                echo "Generating configure script in $DB_SRC_DIR..."
                autoreconf -ivf
                cd ..
                
                # 3. 修改 Makefile，注入 tirpc 依赖 (解决链接错误)
                # 原理：在 ./configure 之前加入环境变量，强制包含 /usr/include/tirpc
                sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' Makefile
            else
                echo "Warning: Dropbear source dir not found!"
            fi
        fi

        # =======================================================
        # 4. 准备 Toolchain
        # =======================================================
        cd $WORK_DIR/toolchain-mipsel
        sh dl_toolchain.sh
        
        # =======================================================
        # 5. 配置文件修改
        # =======================================================
        cd $WORK_DIR/trunk
        
        TEMPLATE_PATH="configs/templates/NEWIFI3.config"
        [ ! -f "$TEMPLATE_PATH" ] && TEMPLATE_PATH="configs/templates/newifi3.config"
        
        if [ ! -f "$TEMPLATE_PATH" ]; then
          echo "Error: Config template not found!"
          exit 1
        fi
        
        # 净化插件，减少出错概率
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_WGET=y/CONFIG_FIRMWARE_INCLUDE_WGET=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENVPN=y/CONFIG_FIRMWARE_INCLUDE_OPENVPN=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TROJAN=y/CONFIG_FIRMWARE_INCLUDE_TROJAN=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_V2RAY=y/CONFIG_FIRMWARE_INCLUDE_V2RAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_XRAY=y/CONFIG_FIRMWARE_INCLUDE_XRAY=n/g' $TEMPLATE_PATH

        # 开启硬件加速
        sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $TEMPLATE_PATH
        if ! grep -q "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD" $TEMPLATE_PATH; then
           echo "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y" >> $TEMPLATE_PATH
        fi
        
        cp -f $TEMPLATE_PATH .config
        
        # =======================================================
        # 6. 开始编译
        # =======================================================
        echo "Starting Build..."
        make clean
        fakeroot ./build_firmware $TARGET_PROFILE
        
    - name: Organize Artifacts
      run: |
        mkdir -p ./output_firmware
        cp ${{ github.workspace }}/padavan/trunk/images/*.trx ./output_firmware/ 2>/dev/null || true
        
        if [ "$(ls -A ./output_firmware)" ]; then
           echo "FIRMWARE_PATH=./output_firmware" >> $GITHUB_ENV
           echo "Build Success!"
        else
           echo "Build Failed: No firmware file found."
           exit 1
        fi

    - name: Upload Firmware to Releases
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.DATE }}-newifi3-${{ env.BUILD_VER }}
        name: Newifi3 D2 Padavan ${{ env.BUILD_VER }} (${{ env.DATE }})
        body: |
          Newifi3 D2 自动构建固件
          - 版本: Padavan ${{ env.BUILD_VER }}
          - 编译日期: ${{ env.DATE }}
          - 修复: Dropbear & xz build fixes applied
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
