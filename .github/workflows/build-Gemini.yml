name: Build Newifi3 D2 (Fixed 4.4 Structure)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Select Kernel Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (Hanwckf + KVR + 22.04 Fix)'
          - '4.4 (MeIsReallyBa + Docker)'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Ubuntu 22.04 Env
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo \
          libtirpc-dev pkg-config unzip \
          automake autoconf gettext
        sudo apt-get clean
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Run Compilation Logic
      run: |
        # =======================================================
        # 0. 识别选择的版本
        # =======================================================
        INPUT_VER="${{ github.event.inputs.target_version }}"
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p $WORK_DIR
        
        IS_KERNEL_44="false"
        
        if [[ "$INPUT_VER" == *"4.4"* ]]; then
            echo "Selection: Kernel 4.4 (MeIsReallyBa)"
            REPO_URL="https://github.com/MeIsReallyBa/padavan-4.4.git"
            REPO_BRANCH="main"
            IS_KERNEL_44="true"
        else
            echo "Selection: Kernel 3.4 (Hanwckf)"
            REPO_URL="https://github.com/hanwckf/rt-n56u.git"
            REPO_BRANCH="master"
            IS_KERNEL_44="false"
        fi

        TARGET_PROFILE="NEWIFI3"
        CURRENT_DATE=$(date +%Y%m%d)
        echo "DATE=$CURRENT_DATE" >> $GITHUB_ENV
        echo "IS_KERNEL_44=$IS_KERNEL_44" >> $GITHUB_ENV
        
        # =======================================================
        # 1. 拉取源码
        # =======================================================
        echo "Cloning Source from $REPO_URL ..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL $WORK_DIR
        
        # =======================================================
        # 2. 准备工具链
        # =======================================================
        echo "Preparing Toolchain..."
        cd $WORK_DIR/toolchain-mipsel
        
        if [ -f "dl_toolchain.sh" ]; then
            sh dl_toolchain.sh
        fi
        
        sudo mkdir -p /opt/rt-n56u
        TC_DIR=$(find $WORK_DIR/toolchain-mipsel -maxdepth 1 -type d -name "toolchain-*" | head -n 1)
        if [ -d "$TC_DIR" ]; then
            sudo ln -sf "$TC_DIR" /opt/rt-n56u/toolchain-mipsel
            echo "Linked $TC_DIR to /opt/rt-n56u/toolchain-mipsel"
        else
            echo "ERROR: Could not detect toolchain directory!"
            exit 1
        fi

        # =======================================================
        # 3. 3.4 版本专属修补 (KVR + Ubuntu Fix)
        # =======================================================
        if [ "$IS_KERNEL_44" == "false" ]; then
            echo ">>> Applying 3.4 specific patches..."
            
            # KVR 注入
            KVR_TEMP="/tmp/padavan_kvr"
            git clone --depth=1 https://github.com/vb1980/Padavan-KVR.git $KVR_TEMP
            DEST_DRIVER_DIR="$WORK_DIR/trunk/proprietary_driver/rt_wifi"
            SRC_MT7603=$(find $KVR_TEMP -type d -name "mt7603e*" -print -quit)
            SRC_MT7612=$(find $KVR_TEMP -type d -name "mt7612e*" -print -quit)
            
            if [ -n "$SRC_MT7603" ]; then
                rm -rf $DEST_DRIVER_DIR/mt7603e
                cp -r "$SRC_MT7603" $DEST_DRIVER_DIR/mt7603e
            fi
            if [ -n "$SRC_MT7612" ]; then
                rm -rf $DEST_DRIVER_DIR/mt7612e
                cp -r "$SRC_MT7612" $DEST_DRIVER_DIR/mt7612e
            fi
            rm -rf $KVR_TEMP
            
            # 22.04 编译报错修复
            if [ -d "$WORK_DIR/trunk/tools/mksquashfs_xz" ]; then
                cd $WORK_DIR/trunk/tools/mksquashfs_xz
                sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' Makefile
            fi
            cd $WORK_DIR/trunk/user/dropbear
            sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' Makefile
        fi

        # =======================================================
        # 4. 关键修正：配置路径适配
        # =======================================================
        cd $WORK_DIR/trunk
        
        TEMPLATE_PATH=""
        
        if [ "$IS_KERNEL_44" == "true" ]; then
            # --- 4.4 版本逻辑 ---
            echo "Configuring for Kernel 4.4..."
            
            # 检测是否存在 NEWIFI 目录 (MeIsReallyBa 的命名习惯)
            if [ -d "configs/boards/NEWIFI" ]; then
                echo "Found 'NEWIFI' board config. Copying to 'NEWIFI3'..."
                cp -r configs/boards/NEWIFI configs/boards/NEWIFI3
            else
                echo "ERROR: Could not find configs/boards/NEWIFI in 4.4 source!"
                ls configs/boards
                exit 1
            fi
            
            # 4.4 的插件开关通常在 board.mk 文件中
            TEMPLATE_PATH="configs/boards/NEWIFI3/board.mk"
            
        else
            # --- 3.4 版本逻辑 ---
            echo "Configuring for Kernel 3.4..."
            
            # 3.4 通常在 templates 下
            if [ -f "configs/templates/NEWIFI3.config" ]; then
                TEMPLATE_PATH="configs/templates/NEWIFI3.config"
            elif [ -f "configs/templates/newifi3.config" ]; then
                TEMPLATE_PATH="configs/templates/newifi3.config"
            else
                echo "ERROR: Config not found for 3.4!"
                exit 1
            fi
            
            # 3.4 驱动版本修正
            sed -i 's/CONFIG_FIRMWARE_WIFI2_DRIVER=.*$/CONFIG_FIRMWARE_WIFI2_DRIVER=5.0/g' $TEMPLATE_PATH
            sed -i 's/CONFIG_FIRMWARE_WIFI5_DRIVER=.*$/CONFIG_FIRMWARE_WIFI5_DRIVER=3.0/g' $TEMPLATE_PATH
            
            # 3.4 开启 KVR
            if ! grep -q "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR" $TEMPLATE_PATH; then
                echo "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y" >> $TEMPLATE_PATH
            else
                sed -i 's/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=n/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y/g' $TEMPLATE_PATH
            fi
        fi

        echo "Modifying config file: $TEMPLATE_PATH"

        # =======================================================
        # 5. 通用配置修改 (精简插件 + 硬件加速)
        # =======================================================
        
        # 关闭常见插件 (减少体积)
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENVPN=y/CONFIG_FIRMWARE_INCLUDE_OPENVPN=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_XRAY=y/CONFIG_FIRMWARE_INCLUDE_XRAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_V2RAY=y/CONFIG_FIRMWARE_INCLUDE_V2RAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TROJAN=y/CONFIG_FIRMWARE_INCLUDE_TROJAN=n/g' $TEMPLATE_PATH
        
        # 开启 Flow Offload (硬件加速)
        sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $TEMPLATE_PATH

        # 对于 3.4 版本，需要手动生成 .config；4.4 版本 build_firmware 会自己处理
        if [ "$IS_KERNEL_44" == "false" ]; then
            cp -f $TEMPLATE_PATH .config
        fi
        
        # =======================================================
        # 6. 开始编译
        # =======================================================
        echo "Starting Build..."
        make clean
        
        # 4.4 的编译可能会因为并行数太高在 GitHub Actions 内存不足而失败，使用 fakeroot 运行
        fakeroot ./build_firmware $TARGET_PROFILE
        
    - name: Organize Artifacts
      run: |
        mkdir -p ./output_firmware
        cp ${{ github.workspace }}/padavan/trunk/images/*.trx ./output_firmware/ 2>/dev/null || true
        
        if [ "$(ls -A ./output_firmware)" ]; then
           echo "FIRMWARE_PATH=./output_firmware" >> $GITHUB_ENV
           echo "Build Success!"
        else
           echo "Build Failed. Check logs."
           exit 1
        fi

    - name: Upload Firmware
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.DATE }}-newifi3-auto
        name: Newifi3 AutoBuild ${{ env.DATE }}
        body: |
          Newifi3 D2 自动构建 (Ubuntu 22.04)
          - 内核: ${{ env.IS_KERNEL_44 == 'true' && '4.4 (MeIsReallyBa)' || '3.4 (Hanwckf)' }}
          - 状态: Build Successful
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
